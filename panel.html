<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Dynamic Config</title>
    <style>
        body {
            font-family: Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--primary-background-color, #fafafa);
            color: var(--primary-text-color, #212121);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: var(--primary-color, #03a9f4);
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 16px;
            color: var(--primary-text-color, #212121);
        }
        .tab.active {
            border-bottom-color: var(--primary-color, #03a9f4);
            color: var(--primary-color, #03a9f4);
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .card {
            background: var(--card-background-color, white);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-text-color, #212121);
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            background: var(--card-background-color, white);
            color: var(--primary-text-color, #212121);
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            margin-bottom: 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }
        button {
            background-color: var(--primary-color, #03a9f4);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: var(--dark-primary-color, #0288d1);
        }
        button.secondary {
            background-color: #757575;
        }
        button.secondary:hover {
            background-color: #616161;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #d32f2f;
        }
        .config-list {
            list-style: none;
            padding: 0;
        }
        .config-item {
            background: var(--card-background-color, white);
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .config-info {
            flex: 1;
        }
        .config-name {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .config-value {
            color: #757575;
            font-size: 14px;
        }
        .config-meta {
            font-size: 12px;
            color: #9e9e9e;
            margin-top: 5px;
        }
        .config-actions {
            display: flex;
            gap: 10px;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }
        .badge-time {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .badge-schedule {
            background-color: #fff3e0;
            color: #f57c00;
        }
        .badge-standard {
            background-color: #f5f5f5;
            color: #616161;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        .notification.success {
            background-color: #4caf50;
            color: white;
        }
        .notification.error {
            background-color: #f44336;
            color: white;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        .time-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9e9e9e;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Dynamic Config Manager</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('list')">üìã Lista Configurazioni</button>
            <button class="tab" onclick="switchTab('standard')">‚öôÔ∏è Standard</button>
            <button class="tab" onclick="switchTab('schedule')">üïê A Orario</button>
            <button class="tab" onclick="switchTab('time')">üìÖ A Tempo</button>
        </div>

        <!-- Tab Lista Configurazioni -->
        <div id="tab-list" class="tab-content active">
            <div class="card">
                <h2>Configurazioni Esistenti</h2>
                <div id="config-list-container" class="loading">
                    Caricamento...
                </div>
            </div>
        </div>

        <!-- Tab Configurazione Standard -->
        <div id="tab-standard" class="tab-content">
            <div class="card">
                <h2>Nuova Configurazione Standard</h2>
                <form id="form-standard">
                    <div class="form-group">
                        <label for="std-name">Nome Configurazione:</label>
                        <input type="text" id="std-name" required placeholder="es. temperatura_target">
                    </div>
                    <div class="form-group">
                        <label for="std-value">Valore:</label>
                        <input type="text" id="std-value" required placeholder="es. 22">
                    </div>
                    <div class="form-group">
                        <label for="std-priority">Priorit√† (1-999):</label>
                        <input type="number" id="std-priority" min="1" max="999" value="99">
                    </div>
                    <button type="submit">Salva Configurazione</button>
                </form>
            </div>
        </div>

        <!-- Tab Configurazione A Orario -->
        <div id="tab-schedule" class="tab-content">
            <div class="card">
                <h2>Nuova Configurazione A Orario</h2>
                <form id="form-schedule">
                    <div class="form-group">
                        <label for="sch-name">Nome Configurazione:</label>
                        <input type="text" id="sch-name" required placeholder="es. temperatura_target">
                    </div>
                    <div class="form-group">
                        <label for="sch-value">Valore:</label>
                        <input type="text" id="sch-value" required placeholder="es. 20">
                    </div>
                    <div class="form-group">
                        <label>Fascia Oraria:</label>
                        <div class="time-input-group">
                            <div>
                                <label for="sch-from">Dalle (es. 8.30):</label>
                                <input type="number" id="sch-from" step="0.01" min="0" max="23.59" required placeholder="8.30">
                            </div>
                            <div>
                                <label for="sch-to">Alle (es. 18.00):</label>
                                <input type="number" id="sch-to" step="0.01" min="0" max="23.59" required placeholder="18.00">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Giorni della Settimana:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="days" value="0" checked> Luned√¨</label>
                            <label><input type="checkbox" name="days" value="1" checked> Marted√¨</label>
                            <label><input type="checkbox" name="days" value="2" checked> Mercoled√¨</label>
                            <label><input type="checkbox" name="days" value="3" checked> Gioved√¨</label>
                            <label><input type="checkbox" name="days" value="4" checked> Venerd√¨</label>
                            <label><input type="checkbox" name="days" value="5" checked> Sabato</label>
                            <label><input type="checkbox" name="days" value="6" checked> Domenica</label>
                        </div>
                    </div>
                    <button type="submit">Salva Configurazione</button>
                </form>
            </div>
        </div>

        <!-- Tab Configurazione A Tempo -->
        <div id="tab-time" class="tab-content">
            <div class="card">
                <h2>Nuova Configurazione A Tempo</h2>
                <form id="form-time">
                    <div class="form-group">
                        <label for="time-name">Nome Configurazione:</label>
                        <input type="text" id="time-name" required placeholder="es. temperatura_target">
                    </div>
                    <div class="form-group">
                        <label for="time-value">Valore:</label>
                        <input type="text" id="time-value" required placeholder="es. 18">
                    </div>
                    <div class="form-group">
                        <label for="time-from">Data/Ora Inizio:</label>
                        <input type="datetime-local" id="time-from" required>
                    </div>
                    <div class="form-group">
                        <label for="time-to">Data/Ora Fine:</label>
                        <input type="datetime-local" id="time-to" required>
                    </div>
                    <button type="submit">Salva Configurazione</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const hass = parent.document.querySelector('home-assistant').hass;
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            if (tabName === 'list') {
                loadConfigurations();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function callService(service, data) {
            try {
                await hass.callService('dynamic_config', service, data);
                return true;
            } catch (error) {
                console.error('Error calling service:', error);
                throw error;
            }
        }

        async function loadConfigurations() {
            const container = document.getElementById('config-list-container');
            container.innerHTML = '<div class="loading">Caricamento...</div>';
            
            try {
                const result = await hass.callService('dynamic_config', 'get_configurations', {}, true);
                const configs = result.response.configurations || {};
                
                if (Object.keys(configs).length === 0) {
                    container.innerHTML = '<div class="empty-state">Nessuna configurazione presente</div>';
                    return;
                }
                
                let html = '<ul class="config-list">';
                for (const [name, config] of Object.entries(configs)) {
                    const badgeClass = config.source === 'time' ? 'badge-time' : 
                                      config.source === 'schedule' ? 'badge-schedule' : 'badge-standard';
                    const sourceLabel = config.source === 'time' ? 'A Tempo' :
                                       config.source === 'schedule' ? 'A Orario' : 'Standard';
                    
                    let meta = '';
                    if (config.priority) meta += `Priorit√†: ${config.priority}`;
                    if (config.valid_to) meta += ` | Valido fino: ${config.valid_to}`;
                    if (config.days_of_week) {
                        const dayNames = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'];
                        const days = config.days_of_week.map(d => dayNames[d]).join(', ');
                        meta += ` | Giorni: ${days}`;
                    }
                    
                    html += `
                        <li class="config-item">
                            <div class="config-info">
                                <div class="config-name">
                                    <span class="badge ${badgeClass}">${sourceLabel}</span>
                                    ${name}
                                </div>
                                <div class="config-value">Valore: <strong>${config.value}</strong></div>
                                ${meta ? `<div class="config-meta">${meta}</div>` : ''}
                            </div>
                            <div class="config-actions">
                                <button class="danger" onclick="deleteConfig('${name}')">Elimina</button>
                            </div>
                        </li>
                    `;
                }
                html += '</ul>';
                
                container.innerHTML = html;
            } catch (error) {
                console.error('Error loading configurations:', error);
                container.innerHTML = '<div class="empty-state">Errore nel caricamento delle configurazioni</div>';
            }
        }

        async function deleteConfig(name) {
            if (!confirm(`Sei sicuro di voler eliminare la configurazione "${name}"?`)) {
                return;
            }
            
            try {
                await callService('delete_config', {
                    setup_name: name,
                    config_type: 'all'
                });
                showNotification('Configurazione eliminata con successo!');
                loadConfigurations();
            } catch (error) {
                showNotification('Errore durante l\'eliminazione', 'error');
            }
        }

        // Form Standard
        document.getElementById('form-standard').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                await callService('set_config', {
                    setup_name: document.getElementById('std-name').value,
                    setup_value: document.getElementById('std-value').value,
                    priority: parseInt(document.getElementById('std-priority').value)
                });
                
                showNotification('Configurazione salvata con successo!');
                e.target.reset();
            } catch (error) {
                showNotification('Errore durante il salvataggio', 'error');
            }
        });

        // Form A Orario
        document.getElementById('form-schedule').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const days = Array.from(document.querySelectorAll('input[name="days"]:checked'))
                .map(cb => cb.value);
            
            if (days.length === 0) {
                showNotification('Seleziona almeno un giorno', 'error');
                return;
            }
            
            try {
                await callService('set_schedule_config', {
                    setup_name: document.getElementById('sch-name').value,
                    setup_value: document.getElementById('sch-value').value,
                    valid_from_ora: parseFloat(document.getElementById('sch-from').value),
                    valid_to_ora: parseFloat(document.getElementById('sch-to').value),
                    days_of_week: days
                });
                
                showNotification('Configurazione salvata con successo!');
                e.target.reset();
                // Reimposta tutti i checkbox
                document.querySelectorAll('input[name="days"]').forEach(cb => cb.checked = true);
            } catch (error) {
                showNotification('Errore durante il salvataggio', 'error');
            }
        });

        // Form A Tempo
        document.getElementById('form-time').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fromValue = document.getElementById('time-from').value;
            const toValue = document.getElementById('time-to').value;
            
            // Converti in formato datetime per SQLite
            const formatDateTime = (dt) => dt.replace('T', ' ') + ':00';
            
            try {
                await callService('set_time_config', {
                    setup_name: document.getElementById('time-name').value,
                    setup_value: document.getElementById('time-value').value,
                    valid_from: formatDateTime(fromValue),
                    valid_to: formatDateTime(toValue)
                });
                
                showNotification('Configurazione salvata con successo!');
                e.target.reset();
            } catch (error) {
                showNotification('Errore durante il salvataggio', 'error');
            }
        });

        // Carica le configurazioni all'avvio
        loadConfigurations();
    </script>
</body>
</html>
